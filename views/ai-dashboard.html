{{template "layout/start"}}

<div class="container mx-auto px-4 py-6 max-w-6xl">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold">AI Command Center</h1>
      <p class="text-base-content/70 mt-2">Intelligent automation managing your code 24/7</p>
    </div>
    <div class="flex gap-3 mt-4 sm:mt-0">
      <label for="ai-drawer-toggle" class="btn btn-secondary drawer-button">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        Open Assistant
      </label>
    </div>
  </div>

  <!-- Real-time Status Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- AI Service Status -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-sm font-semibold text-base-content/70">AI Service</h3>
          <div class="relative">
            {{if ai.IsAIEnabled}}
              <span class="badge badge-success badge-sm">Active</span>
            {{else}}
              <span class="badge badge-error badge-sm">Offline</span>
            {{end}}
          </div>
        </div>
        <div class="flex items-end justify-between">
          <div>
            <p class="text-3xl font-bold">
              {{if ai.IsAIEnabled}}
                Llama 3.2
              {{else}}
                Disabled
              {{end}}
            </p>
            <p class="text-xs text-base-content/50 mt-1">3b parameters</p>
          </div>
          <div class="radial-progress text-primary" style="--value:{{if ai.IsAIEnabled}}100{{else}}0{{end}}; --size:3rem;">
            <span class="text-xs">{{if ai.IsAIEnabled}}100%{{else}}0%{{end}}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Queue Status -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        {{with ai.GetQueueStats}}
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-sm font-semibold text-base-content/70">Task Queue</h3>
          {{if .running}}
            <span class="badge badge-primary badge-sm">Processing</span>
          {{else}}
            <span class="badge badge-warning badge-sm">Idle</span>
          {{end}}
        </div>
        <div class="flex items-end justify-between">
          <div>
            <p class="text-3xl font-bold">{{.queue_length}}</p>
            <p class="text-xs text-base-content/50 mt-1">tasks queued</p>
          </div>
          <div class="flex flex-col items-end text-xs">
            <span class="text-success">{{.processing}} active</span>
            <span class="text-base-content/50">{{.workers}} workers</span>
          </div>
        </div>
        {{else}}
        <div class="text-center py-4">
          <p class="text-base-content/50">Queue offline</p>
        </div>
        {{end}}
      </div>
    </div>

    <!-- Processing Stats -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        {{with ai.GetQueueStats}}
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-sm font-semibold text-base-content/70">Processing</h3>
          <span class="badge badge-info badge-sm">24h</span>
        </div>
        <div class="flex items-end justify-between">
          <div>
            <p class="text-3xl font-bold">{{.total_processed}}</p>
            <p class="text-xs text-base-content/50 mt-1">completed</p>
          </div>
          <div class="flex flex-col items-end text-xs">
            <span class="text-error">{{.total_failed}} failed</span>
            <span class="text-warning">{{.total_retried}} retried</span>
          </div>
        </div>
        {{end}}
      </div>
    </div>

    <!-- Performance -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        {{with ai.GetQueueStats}}
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-sm font-semibold text-base-content/70">Performance</h3>
          <span class="badge badge-accent badge-sm">Avg</span>
        </div>
        <div class="flex items-end justify-between">
          <div>
            <p class="text-3xl font-bold">{{.average_time_ms}}</p>
            <p class="text-xs text-base-content/50 mt-1">ms per task</p>
          </div>
          <div class="text-xs text-base-content/50">
            <span>{{if eq .status "processing"}}Active{{else}}Idle{{end}}</span>
          </div>
        </div>
        {{end}}
      </div>
    </div>
  </div>

  <!-- Automation Controls -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
    <!-- Active Automations -->
    <div class="lg:col-span-2 card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <h2 class="card-title text-xl mb-4">Active Automations</h2>
        
        {{$stats := ai.GetTodayStats}}
        {{$features := ai.GetFeatureStatus}}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Issue Triage -->
          <label class="card bg-base-200/50 border border-base-300 cursor-pointer">
            <div class="card-body p-4">
              <div class="flex items-start gap-3">
                <input type="checkbox" class="toggle toggle-primary mt-1" {{if $features.issue_triage}}checked{{end}}
                  hx-post="/ai/toggle/issue_triage" hx-trigger="change" />
                <div class="flex-1">
                  <h4 class="font-semibold">Issue Triage</h4>
                  <p class="text-xs text-base-content/60 mt-1">
                    Automatically analyze, label, and prioritize new issues
                  </p>
                  <div class="flex gap-2 mt-2">
                    {{if $features.issue_triage}}
                      <span class="badge badge-xs badge-success">Active</span>
                      {{if gt $stats.issue_triage 0}}
                        <span class="badge badge-xs">{{$stats.issue_triage}} today</span>
                      {{end}}
                    {{else}}
                      <span class="badge badge-xs badge-ghost">Disabled</span>
                    {{end}}
                  </div>
                </div>
              </div>
            </div>
          </label>

          <!-- PR Review -->
          <label class="card bg-base-200/50 border border-base-300 cursor-pointer">
            <div class="card-body p-4">
              <div class="flex items-start gap-3">
                <input type="checkbox" class="toggle toggle-primary mt-1" {{if $features.pr_review}}checked{{end}}
                  hx-post="/ai/toggle/pr_review" hx-trigger="change" />
                <div class="flex-1">
                  <h4 class="font-semibold">PR Review</h4>
                  <p class="text-xs text-base-content/60 mt-1">
                    Review code changes and provide feedback
                  </p>
                  <div class="flex gap-2 mt-2">
                    {{if $features.pr_review}}
                      <span class="badge badge-xs badge-success">Active</span>
                      {{if gt $stats.pr_review 0}}
                        <span class="badge badge-xs">{{$stats.pr_review}} today</span>
                      {{end}}
                    {{else}}
                      <span class="badge badge-xs badge-ghost">Disabled</span>
                    {{end}}
                  </div>
                </div>
              </div>
            </div>
          </label>

          <!-- Auto-Approve -->
          <label class="card bg-base-200/50 border border-base-300 cursor-pointer">
            <div class="card-body p-4">
              <div class="flex items-start gap-3">
                <input type="checkbox" class="toggle toggle-warning mt-1" {{if $features.auto_approve}}checked{{end}}
                  hx-post="/ai/toggle/auto_approve" hx-trigger="change" />
                <div class="flex-1">
                  <h4 class="font-semibold">Auto-Approve</h4>
                  <p class="text-xs text-base-content/60 mt-1">
                    Approve safe changes like docs and configs
                  </p>
                  <div class="flex gap-2 mt-2">
                    {{if $features.auto_approve}}
                      <span class="badge badge-xs badge-warning">Cautious</span>
                      {{if gt $stats.auto_approve 0}}
                        <span class="badge badge-xs">{{$stats.auto_approve}} today</span>
                      {{end}}
                    {{else}}
                      <span class="badge badge-xs badge-ghost">Disabled</span>
                    {{end}}
                  </div>
                </div>
              </div>
            </div>
          </label>

          <!-- Daily Reports -->
          <label class="card bg-base-200/50 border border-base-300 cursor-pointer">
            <div class="card-body p-4">
              <div class="flex items-start gap-3">
                <input type="checkbox" class="toggle toggle-primary mt-1" {{if $features.daily_reports}}checked{{end}}
                  hx-post="/ai/toggle/daily_reports" hx-trigger="change" />
                <div class="flex-1">
                  <h4 class="font-semibold">Daily Reports</h4>
                  <p class="text-xs text-base-content/60 mt-1">
                    Generate repository health summaries
                  </p>
                  <div class="flex gap-2 mt-2">
                    {{if $features.daily_reports}}
                      <span class="badge badge-xs badge-info">Enabled</span>
                    {{else}}
                      <span class="badge badge-xs badge-ghost">Disabled</span>
                    {{end}}
                  </div>
                </div>
              </div>
            </div>
          </label>

          <!-- Stale Management -->
          <label class="card bg-base-200/50 border border-base-300 cursor-pointer">
            <div class="card-body p-4">
              <div class="flex items-start gap-3">
                <input type="checkbox" class="toggle toggle-warning mt-1" {{if $features.stale_management}}checked{{end}}
                  hx-post="/ai/toggle/stale_management" hx-trigger="change" />
                <div class="flex-1">
                  <h4 class="font-semibold">Stale Management</h4>
                  <p class="text-xs text-base-content/60 mt-1">
                    Handle inactive issues and PRs
                  </p>
                  <div class="flex gap-2 mt-2">
                    {{if $features.stale_management}}
                      <span class="badge badge-xs badge-info">Enabled</span>
                    {{else}}
                      <span class="badge badge-xs badge-ghost">Disabled</span>
                    {{end}}
                  </div>
                </div>
              </div>
            </div>
          </label>

          <!-- Security Scanning -->
          <label class="card bg-base-200/50 border border-base-300 cursor-pointer">
            <div class="card-body p-4">
              <div class="flex items-start gap-3">
                <input type="checkbox" class="toggle toggle-error mt-1" {{if $features.security_scan}}checked{{end}}
                  hx-post="/ai/toggle/security_scan" hx-trigger="change" />
                <div class="flex-1">
                  <h4 class="font-semibold">Security Scanning</h4>
                  <p class="text-xs text-base-content/60 mt-1">
                    Scan for vulnerabilities and risks
                  </p>
                  <div class="flex gap-2 mt-2">
                    {{if $features.security_scan}}
                      <span class="badge badge-xs badge-error">Beta</span>
                    {{else}}
                      <span class="badge badge-xs badge-ghost">Disabled</span>
                    {{end}}
                  </div>
                </div>
              </div>
            </div>
          </label>
        </div>
      </div>
    </div>

    <!-- AI Settings -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <h2 class="card-title text-xl mb-4">AI Behavior</h2>
        {{$config := ai.GetCurrentConfig}}
        
        <!-- AI Model (readonly) -->
        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text font-semibold">AI Model</span>
          </label>
          <input type="text" value="{{$config.model}}" class="input input-bordered w-full" readonly />
          <label class="label">
            <span class="label-text-alt text-xs">Currently active AI model</span>
          </label>
        </div>

        <!-- Automation Level -->
        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text font-semibold">Automation Level</span>
          </label>
          <select class="select select-bordered w-full" 
            name="aggressiveness"
            hx-post="/ai/config/aggressiveness" 
            hx-trigger="change"
            hx-vals='{"aggressiveness": "this.value"}'>
            <option value="conservative" {{if eq $config.automation_level "conservative"}}selected{{end}}>Conservative - Suggest only</option>
            <option value="balanced" {{if eq $config.automation_level "balanced"}}selected{{end}}>Balanced - Act on clear cases</option>
            <option value="aggressive" {{if eq $config.automation_level "aggressive"}}selected{{end}}>Aggressive - Proactive automation</option>
          </select>
          <label class="label">
            <span class="label-text-alt text-xs">How autonomous should the AI be?</span>
          </label>
        </div>

        <!-- Response Delay -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Response Delay</span>
          </label>
          <div class="flex items-center gap-3">
            <input type="range" 
              min="0" 
              max="300" 
              value="{{$config.response_delay}}" 
              class="range range-primary flex-1" 
              id="response-delay" 
              name="delay"
              hx-post="/ai/config/delay" 
              hx-trigger="change delay:500ms"
              hx-vals='{"delay": "this.value"}' />
            <span class="badge badge-lg" id="delay-value">{{$config.response_delay}}s</span>
          </div>
          <label class="label">
            <span class="label-text-alt text-xs">Wait time before AI responds to new issues/PRs</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Feed -->
  <div class="card bg-base-100 shadow-sm border border-base-300">
    <div class="card-body">
      <div class="flex items-center justify-between mb-4">
        <h2 class="card-title text-xl">Recent AI Activity</h2>
        <button class="btn btn-sm btn-ghost gap-2" 
          hx-get="/ai/activity/feed" hx-target="#activity-feed" hx-trigger="click">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Refresh
        </button>
      </div>
      
      <div class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>Time</th>
              <th>Type</th>
              <th>Repository</th>
              <th>Action</th>
              <th>Duration</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="activity-feed" hx-get="/ai/activity/feed" hx-trigger="load, every 10s">
            {{range ai.GetRecentActivity}}
            <tr>
              <td>
                <span class="text-xs text-base-content/70">{{.CreatedAt.Format "15:04:05"}}</span>
              </td>
              <td>
                <span class="badge badge-sm badge-outline 
                  {{if eq .Type "issue_triage"}}badge-primary{{end}}
                  {{if eq .Type "pr_review"}}badge-secondary{{end}}
                  {{if eq .Type "security_scan"}}badge-error{{end}}">
                  {{.Type}}
                </span>
              </td>
              <td>
                <a href="/repos/{{.RepoID}}" class="link link-hover">{{.RepoName}}</a>
              </td>
              <td class="max-w-xs">
                <span class="text-sm truncate">{{.Description}}</span>
              </td>
              <td>
                <span class="text-xs">{{.Duration}}ms</span>
              </td>
              <td>
                {{if .Success}}
                  <span class="badge badge-success badge-xs gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                    </svg>
                    Success
                  </span>
                {{else}}
                  <span class="badge badge-error badge-xs gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Failed
                  </span>
                {{end}}
              </td>
            </tr>
            {{else}}
            <tr>
              <td colspan="6" class="text-center py-8">
                <div class="flex flex-col items-center gap-2 text-base-content/50">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                  </svg>
                  <p>No recent AI activity</p>
                  <p class="text-xs">AI tasks will appear here as they're processed</p>
                </div>
              </td>
            </tr>
            {{end}}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<!-- Inline JavaScript for real-time updates -->
<script>
  // Update delay value display
  document.getElementById('response-delay')?.addEventListener('input', function(e) {
    document.getElementById('delay-value').textContent = e.target.value + 's';
  });
</script>

{{template "layout/end"}}
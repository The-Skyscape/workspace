{{template "layout/start"}}
{{with $repo := repos.CurrentRepo}}
{{template "repo-breadcrumbs.html" .}}

{{template "repo-header.html" .}}

{{template "repo-tabs.html" .}}

<!-- File Editor -->
{{with repos.CurrentFile}}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

  <!-- Main Editor Content -->
  <div class="lg:col-span-3">
    <div class="card bg-base-100 shadow-lg border border-base-300">
      <div class="card-body p-0">
        <!-- Editor Header -->
        <div class="flex items-center justify-between p-6 border-b border-base-300">
          <div class="flex items-center space-x-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
            <div>
              <h2 class="text-xl font-bold">Editing {{.Name}}</h2>
              <div class="text-sm text-base-content/70">
                {{.Size}} bytes â€¢ {{.Language}}
              </div>
            </div>
          </div>
          
          <div class="flex items-center space-x-2">
            <a href="{{host}}/repos/{{$repo.ID}}/files/{{.Path}}?branch={{repos.CurrentBranch}}" class="btn btn-ghost btn-sm">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
              Cancel
            </a>
          </div>
        </div>

        <!-- Editor Form -->
        <form hx-post="{{host}}/repos/{{$repo.ID}}/files/save" hx-target="body" hx-swap="outerHTML" class="p-6">
          <input type="hidden" name="path" value="{{.Path}}">
          <input type="hidden" name="branch" value="{{repos.CurrentBranch}}">
          
          <!-- Commit Information -->
          <fieldset class="fieldset bg-base-200 border border-base-300 rounded-box mb-6">
            <legend class="fieldset-legend">Commit Information</legend>
            <input type="text" name="commit_message" placeholder="Update {{.Name}}" class="input input-bordered w-full" required>
            <p class="label">Commit Message <span class="text-error">*</span> - Describe your changes</p>
          </fieldset>

          <!-- File Content Editor -->
          <fieldset class="fieldset bg-base-200 border border-base-300 rounded-box mb-6">
            <legend class="fieldset-legend">File Content</legend>
            <textarea name="content" class="textarea textarea-bordered w-full font-mono text-sm" rows="30" style="resize: vertical;">{{.Content}}</textarea>
            <p class="label">Edit the file content above</p>
          </fieldset>

          <!-- Action Buttons -->
          <div class="flex justify-end space-x-2">
            <a href="{{host}}/repos/{{$repo.ID}}/files/{{.Path}}?branch={{repos.CurrentBranch}}" class="btn btn-ghost">Cancel</a>
            <button type="submit" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1-1V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v1m4 0v1m0-2V4" />
              </svg>
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="space-y-6">

    <!-- Editor Tips -->
    <div class="card bg-base-100 shadow-lg border border-base-300">
      <div class="card-body">
        <h3 class="card-title text-lg">ðŸ’¡ Editor Tips</h3>
        <div class="space-y-2 text-sm">
          <div class="flex items-start space-x-2">
            <kbd class="kbd kbd-xs">Tab</kbd>
            <span>Insert 2 spaces</span>
          </div>
          <div class="flex items-start space-x-2">
            <kbd class="kbd kbd-xs">Ctrl+S</kbd>
            <span>Save file (submit form)</span>
          </div>
          <div class="flex items-start space-x-2">
            <kbd class="kbd kbd-xs">Ctrl+Z</kbd>
            <span>Undo changes</span>
          </div>
        </div>
      </div>
    </div>

    <!-- File Info -->
    <div class="card bg-base-100 shadow-lg border border-base-300">
      <div class="card-body">
        <h3 class="card-title text-lg">File Information</h3>
        <div class="space-y-3">
          <div class="flex justify-between">
            <span class="text-base-content/70">Language</span>
            <span>{{.Language}}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-base-content/70">Size</span>
            <span>{{.Size}} bytes</span>
          </div>
          <div class="flex justify-between">
            <span class="text-base-content/70">Lines</span>
            <span>{{len repos.FileLines}}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-base-content/70">Branch</span>
            <span class="font-mono text-sm">{{repos.CurrentBranch}}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="card bg-base-100 shadow-lg border border-base-300">
      <div class="card-body">
        <h3 class="card-title text-lg">Navigation</h3>
        <div class="space-y-2">
          <a href="{{host}}/repos/{{$repo.ID}}/files/{{.Path}}?branch={{repos.CurrentBranch}}" class="btn btn-outline btn-sm w-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            View File
          </a>
          <a href="{{host}}/repos/{{$repo.ID}}/files" class="btn btn-outline btn-sm w-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2v0a2 2 0 002 2h10" />
            </svg>
            Repository Root
          </a>
        </div>
      </div>
    </div>

  </div>
</div>
{{else}}
<div class="text-center py-16">
  <h2 class="text-2xl font-bold mb-4 text-error">File Not Found</h2>
  <p class="text-base-content/70 mb-6">The file you're trying to edit doesn't exist.</p>
  <a href="{{host}}/repos/{{$repo.ID}}/files" class="btn btn-primary">Back to Repository</a>
</div>
{{end}}
{{else}}
<div class="text-center py-16">
  <h2 class="text-2xl font-bold mb-4 text-error">Repository Not Found</h2>
  <p class="text-base-content/70 mb-6">The repository you're looking for doesn't exist or you don't have access to it.</p>
  <a href="{{host}}/repos" class="btn btn-primary">Back to Repositories</a>
</div>
{{end}}

<!-- Enhanced editor with keyboard shortcuts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.querySelector('textarea[name="content"]');
    const form = document.querySelector('form');
    
    if (textarea) {
        // Handle Tab key for indentation
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                const value = this.value;
                
                // Insert 2 spaces
                this.value = value.substring(0, start) + '  ' + value.substring(end);
                this.selectionStart = this.selectionEnd = start + 2;
            }
        });
        
        // Handle Ctrl+S to save
        textarea.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
            }
        });
    }
});
</script>

{{template "layout/end"}}
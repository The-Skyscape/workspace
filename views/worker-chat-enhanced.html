<div class="flex flex-col h-full" id="worker-chat-container">
  <!-- Header -->
  <div class="flex items-center justify-between p-4 border-b">
    <div class="flex items-center gap-3">
      <button class="btn btn-ghost btn-sm btn-circle"
              hx-get="{{host}}/worker/panel/content"
              hx-target="closest .drawer-side .overflow-y-auto"
              hx-swap="innerHTML">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <div>
        <h3 class="text-lg font-bold">{{.Worker.Name}}</h3>
        <span class="badge badge-success badge-xs">Ready</span>
        <span class="text-xs text-base-content/60 ml-2">Streaming Mode</span>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <form hx-delete="{{host}}/worker/workers/{{.Worker.ID}}"
            hx-target="closest .drawer-side .overflow-y-auto"
            hx-swap="innerHTML"
            hx-confirm="Remove this AI assistant and delete all conversation history?">
        <button type="submit" class="btn btn-ghost btn-sm btn-circle">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      </form>
    </div>
  </div>

  <!-- Repository Context -->
  <div class="px-4 py-2 bg-base-200/50 border-b">
    <div class="flex items-center gap-2 text-sm">
      <span class="text-base-content/70">Working with:</span>
      {{range worker.WorkerRepos}}
      <span class="badge badge-sm">{{.Name}}</span>
      {{else}}
      <span class="text-base-content/50">No repositories</span>
      {{end}}
    </div>
  </div>

  <!-- Chat Messages -->
  <div class="flex-1 overflow-y-auto p-4" id="chat-messages">
    <div hx-get="{{host}}/worker/workers/{{.Worker.ID}}/history"
         hx-trigger="load"
         hx-swap="innerHTML">
      <div class="flex justify-center">
        <span class="loading loading-dots loading-sm"></span>
      </div>
    </div>
  </div>

  <!-- Input Form -->
  <form class="border-t p-4" id="worker-chat-form">
    <div class="flex gap-2">
      <input type="text" 
             id="worker-message-input"
             name="message"
             placeholder="Ask about your repositories..."
             class="input input-bordered flex-1"
             required
             autofocus>
      <button type="submit" class="btn btn-primary" id="worker-send-btn">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
      </button>
    </div>
  </form>
</div>

<script>
(function() {
  const form = document.getElementById('worker-chat-form');
  const input = document.getElementById('worker-message-input');
  const sendBtn = document.getElementById('worker-send-btn');
  const messagesContainer = document.getElementById('chat-messages');
  let eventSource = null;
  
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const message = input.value.trim();
    if (!message) return;
    
    // Add user message to chat
    const userMsg = document.createElement('div');
    userMsg.className = 'chat chat-end mb-4';
    userMsg.innerHTML = `
      <div class="chat-bubble chat-bubble-primary">
        ${escapeHtml(message)}
      </div>
    `;
    messagesContainer.appendChild(userMsg);
    
    // Clear input and disable form
    input.value = '';
    input.disabled = true;
    sendBtn.disabled = true;
    
    // Create assistant message container
    const assistantMsg = document.createElement('div');
    assistantMsg.className = 'chat chat-start mb-4';
    assistantMsg.innerHTML = `
      <div class="chat-bubble" id="worker-response">
        <span class="loading loading-dots loading-sm"></span>
      </div>
    `;
    messagesContainer.appendChild(assistantMsg);
    
    const responseDiv = document.getElementById('worker-response');
    let responseText = '';
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Close existing connection if any
    if (eventSource) {
      eventSource.close();
    }
    
    // Start SSE connection
    eventSource = new EventSource('{{host}}/worker/workers/{{.Worker.ID}}/stream?message=' + encodeURIComponent(message));
    
    eventSource.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);
        
        if (data.type === 'assistant' || data.role === 'assistant') {
          // Remove loading indicator if present
          if (responseText === '') {
            responseDiv.innerHTML = '';
          }
          
          // Handle content which might be string or object
          let content = data.content;
          if (typeof content === 'object' && content !== null) {
            // Claude CLI might send content as array or object
            if (Array.isArray(content)) {
              content = content.map(c => c.text || c.content || '').join('');
            } else {
              content = content.text || content.content || JSON.stringify(content);
            }
          }
          
          // Append content
          if (content) {
            responseText += content + '\n';
            responseDiv.innerHTML = formatMessage(responseText);
          }
          
        } else if (data.type === 'tool' || data.tool_name) {
          // Show tool usage
          const toolDiv = document.createElement('div');
          toolDiv.className = 'text-xs text-base-content/60 italic mb-1 p-2 bg-base-200 rounded';
          
          if (data.tool_name === 'Bash' || data.tool_name === 'bash') {
            const input = data.tool_input || {};
            toolDiv.innerHTML = `üîß Running command: <code>${escapeHtml(input.command || input.cmd || 'bash')}</code>`;
          } else if (data.tool_name === 'Edit' || data.tool_name === 'Write') {
            const input = data.tool_input || {};
            toolDiv.innerHTML = `üìù Editing file: <code>${escapeHtml(input.file_path || input.path || 'file')}</code>`;
          } else if (data.tool_name === 'Read') {
            const input = data.tool_input || {};
            toolDiv.innerHTML = `üìñ Reading file: <code>${escapeHtml(input.file_path || input.path || 'file')}</code>`;
          } else {
            toolDiv.innerHTML = `üîß Using tool: ${escapeHtml(data.tool_name || 'unknown')}`;
          }
          
          responseDiv.appendChild(toolDiv);
          
        } else if (data.type === 'error') {
          responseDiv.innerHTML = `<span class="text-error">Error: ${escapeHtml(data.content || data.error || 'Unknown error')}</span>`;
          
        } else if (data.type === 'done' || data.type === 'result') {
          // Re-enable form
          input.disabled = false;
          sendBtn.disabled = false;
          input.focus();
          
          // Close connection
          eventSource.close();
          eventSource = null;
        }
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
      } catch (err) {
        console.error('Failed to parse SSE data:', err, event.data);
      }
    };
    
    eventSource.onerror = function(err) {
      console.error('SSE error:', err);
      responseDiv.innerHTML = '<span class="text-error">Connection lost. Please try again.</span>';
      
      // Re-enable form
      input.disabled = false;
      sendBtn.disabled = false;
      
      // Close connection
      eventSource.close();
      eventSource = null;
    };
  });
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function formatMessage(text) {
    // Convert markdown-like formatting
    return text
      .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>')
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
      .replace(/\*([^*]+)\*/g, '<em>$1</em>')
      .replace(/\n/g, '<br>');
  }
})();
</script>
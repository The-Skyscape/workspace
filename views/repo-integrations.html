{{template "layout/start"}}
{{with $repo := integrations.CurrentRepo}}
{{template "repo-breadcrumbs.html" .}}

{{template "repo-header.html" .}}

{{template "repo-tabs.html" .}}

<!-- Integrations Container -->
<div class="container mx-auto px-4 py-6 max-w-7xl">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Main Content -->
    <div class="lg:col-span-2 flex flex-col gap-8">

      <!-- GitHub Integration -->
      <div class="card bg-base-100 shadow-lg border border-base-300">
        <div class="card-body">
          <div class="flex items-center gap-3 mb-4">
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
            <div>
              <h2 class="card-title">GitHub Integration</h2>
              <p class="text-base-content/70">Sync this repository with GitHub for backup and collaboration</p>
            </div>
          </div>
          
          {{if integrations.IsGitHubOAuthConfigured}}
          <!-- GitHub OAuth is configured -->
          {{if $repo.GitHubURL}}
          <!-- Repository is connected to GitHub -->
          <div class="bg-success/10 border border-success/20 rounded-lg p-4 mb-4">
            <div class="flex items-center gap-2 mb-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="font-medium">Connected to GitHub</span>
            </div>
            <div class="flex flex-col gap-2">
              <div class="flex items-center gap-2 text-sm">
                <span class="text-base-content/70">Repository:</span>
                <a href="{{.GitHubURL}}" target="_blank" class="link link-primary font-mono">{{.GitHubURL}}</a>
              </div>
              {{if .LastSyncAt}}
              <div class="flex items-center gap-2 text-sm">
                <span class="text-base-content/70">Last synced:</span>
                <span>{{.LastSyncAt.Format "Jan 2, 2006 3:04 PM"}}</span>
              </div>
              {{end}}
              <div class="flex items-center gap-2 text-sm">
                <span class="text-base-content/70">Sync direction:</span>
                <span class="badge badge-outline badge-sm">{{if .SyncDirection}}{{.SyncDirection}}{{else}}push{{end}}</span>
              </div>
              <div class="flex items-center gap-2 text-sm">
                <span class="text-base-content/70">Auto-sync:</span>
                <span>{{if .AutoSync}}Enabled{{else}}Disabled{{end}}</span>
              </div>
            </div>
          </div>
          
          <!-- Sync Status and Controls -->
          <div class="divider">Synchronization</div>
          
          <!-- Sync Status Display -->
          <div class="bg-base-200 rounded-lg p-4 mb-4"
               hx-get="{{host}}/repos/{{.ID}}/github/status"
               hx-trigger="load, every 10s"
               hx-swap="innerHTML">
            <div class="flex items-center justify-center">
              <span class="loading loading-spinner loading-sm"></span>
              <span class="ml-2 text-base-content/70">Loading sync status...</span>
            </div>
          </div>
          
          <!-- Sync Actions -->
          <div class="grid grid-cols-2 gap-2 mb-4">
            <button class="btn btn-primary"
                    hx-post="{{host}}/repos/{{.ID}}/github/push"
                    hx-indicator="#push-indicator"
                    hx-swap="none">
              <span id="push-indicator" class="htmx-indicator">
                <span class="loading loading-spinner loading-xs"></span>
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12" />
              </svg>
              Push to GitHub
            </button>
            
            <button class="btn btn-primary btn-outline"
                    hx-post="{{host}}/repos/{{.ID}}/github/pull"
                    hx-indicator="#pull-indicator"
                    hx-swap="none">
              <span id="pull-indicator" class="htmx-indicator">
                <span class="loading loading-spinner loading-xs"></span>
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6" />
              </svg>
              Pull from GitHub
            </button>
          </div>
          
          <!-- Legacy Sync (Issues/PRs) -->
          <div class="flex gap-2">
            <button class="btn btn-sm btn-ghost"
                    hx-post="{{host}}/repos/{{.ID}}/github/sync"
                    hx-indicator="#sync-indicator"
                    hx-target="body"
                    hx-swap="outerHTML">
              <span id="sync-indicator" class="htmx-indicator">
                <span class="loading loading-spinner loading-xs"></span>
              </span>
              Sync Issues & PRs
            </button>
            <button class="btn btn-sm btn-ghost"
                    _="on click call github_settings_modal.showModal()">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              Settings
            </button>
            <button class="btn btn-sm btn-error btn-ghost"
                    hx-post="{{host}}/repos/{{.ID}}/github/disconnect"
                    hx-confirm="Are you sure you want to disconnect from GitHub? This will not delete any data."
                    hx-target="body"
                    hx-swap="outerHTML">
              Disconnect
            </button>
          </div>
          {{else}}
          <!-- Repository not connected to GitHub -->
          <div class="bg-base-200 rounded-lg p-8 text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-base-content/30" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
            <h3 class="text-lg font-semibold mb-2">Not connected to GitHub</h3>
            <p class="text-base-content/70 mb-6">Connect your repository to GitHub to enable backup and collaboration features</p>
            <button class="btn btn-primary"
                    _="on click call github_link_modal.showModal()">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
              </svg>
              Link to GitHub Repository
            </button>
          </div>
          {{end}}
          {{else}}
          <!-- GitHub OAuth not configured -->
          <div class="bg-base-200 rounded-lg p-8 text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-base-content/30" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
            <h3 class="text-lg font-semibold mb-2">GitHub Integration Not Configured</h3>
            <p class="text-base-content/70 mb-6">An administrator needs to configure GitHub OAuth in Settings first</p>
            <a href="{{host}}/settings" class="btn btn-primary">
              Go to Settings
            </a>
          </div>
          {{end}}
        </div>
      </div>

      <!-- Future Integrations Placeholder -->
      <div class="card bg-base-100 shadow-lg border border-base-300">
        <div class="card-body">
          <h2 class="card-title">More Integrations Coming Soon</h2>
          <p class="text-base-content/70">Additional integrations will be available here in future updates.</p>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <!-- CI/CD Integration -->
            <div class="card bg-base-200 opacity-60">
              <div class="card-body">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                    </svg>
                  </div>
                  <div>
                    <h3 class="font-semibold">CI/CD Pipelines</h3>
                    <p class="text-sm text-base-content/70">Jenkins, GitHub Actions</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cloud Deployment -->
            <div class="card bg-base-200 opacity-60">
              <div class="card-body">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg bg-info/20 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-info" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                    </svg>
                  </div>
                  <div>
                    <h3 class="font-semibold">Cloud Deployment</h3>
                    <p class="text-sm text-base-content/70">AWS, GCP, Azure</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Monitoring -->
            <div class="card bg-base-200 opacity-60">
              <div class="card-body">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg bg-warning/20 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-warning" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                  </div>
                  <div>
                    <h3 class="font-semibold">Monitoring</h3>
                    <p class="text-sm text-base-content/70">Datadog, New Relic</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Communication -->
            <div class="card bg-base-200 opacity-60">
              <div class="card-body">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg bg-success/20 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                  </div>
                  <div>
                    <h3 class="font-semibold">Communication</h3>
                    <p class="text-sm text-base-content/70">Slack, Discord</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Sidebar -->
    <div class="flex flex-col gap-6">

      <!-- Integration Help -->
      <div class="card bg-base-100 shadow-lg border border-base-300">
        <div class="card-body">
          <h3 class="card-title text-lg">Integration Help</h3>
          <div class="flex flex-col gap-3">
            <div>
              <h4 class="font-semibold text-sm mb-1">GitHub Integration</h4>
              <p class="text-xs text-base-content/70">Sync your repository with GitHub for version control and collaboration. Uses secure OAuth authentication - no tokens needed.</p>
            </div>
            <div class="divider my-2"></div>
            <div>
              <h4 class="font-semibold text-sm mb-1">Security Note</h4>
              <p class="text-xs text-base-content/70">Integration credentials are stored securely and never exposed in the UI. Always use tokens with minimal required permissions.</p>
            </div>
          </div>
        </div>
      </div>


    </div>
  </div>
</div>

<!-- GitHub Link Repository Modal -->
<dialog id="github_link_modal" class="modal">
  <div class="modal-box">
    <h3 class="text-2xl font-bold mb-6">Link GitHub Repository</h3>
    <form hx-post="{{host}}/repos/{{.ID}}/github/link" hx-target="body" hx-swap="outerHTML" class="flex flex-col gap-2">
      
      <div class="alert alert-info mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Select an existing GitHub repository or create a new one</span>
      </div>

      <!-- Repository Selection -->
      <div class="tabs tabs-boxed mb-4">
        <input type="radio" name="link_mode" value="existing" class="hidden" id="link-existing" checked />
        <label for="link-existing" class="tab tab-active"
               _="on click 
                  add .hidden to #create-github-fields
                  remove .hidden from #select-github-fields
                  remove .tab-active from .tab
                  add .tab-active to me">
          Select Existing
        </label>
        <input type="radio" name="link_mode" value="create" class="hidden" id="link-create" />
        <label for="link-create" class="tab"
               _="on click 
                  add .hidden to #select-github-fields
                  remove .hidden from #create-github-fields
                  remove .tab-active from .tab
                  add .tab-active to me">
          Create New
        </label>
      </div>

      <div id="select-github-fields">
        <!-- GitHub repository picker loaded via HTMX -->
        <div hx-get="/github/repos" 
             hx-trigger="load" 
             hx-target="this">
          <div class="text-center py-4">
            <span class="loading loading-spinner loading-sm"></span>
            <p class="text-sm text-base-content/60 mt-2">Loading repositories...</p>
          </div>
        </div>
      </div>

      <div id="create-github-fields" class="hidden">
        <label class="form-control w-full">
          <div class="label">
            <span class="label-text text-sm font-medium">Repository Name</span>
            <span class="label-text-alt text-xs">Will be created on GitHub</span>
          </div>
          <input type="text" name="new_repo_name" class="input input-bordered w-full" 
                 placeholder="my-repository" 
                 pattern="[a-zA-Z0-9-_]+" />
        </label>
      </div>

      <label class="form-control w-full">
        <div class="label">
          <span class="label-text text-sm font-medium">Sync Direction</span>
        </div>
        <select name="sync_direction" class="select select-bordered w-full">
          <option value="push">Push only - Send changes to GitHub</option>
          <option value="pull">Pull only - Receive changes from GitHub</option>
          <option value="both" selected>Bidirectional - Sync both ways</option>
        </select>
      </label>

      <div class="form-control">
        <label class="label cursor-pointer">
          <span class="label-text">Enable automatic sync</span>
          <input type="checkbox" name="auto_sync" value="true" class="checkbox checkbox-primary" />
        </label>
      </div>

      <div class="modal-action mt-4">
        <button type="submit" class="btn btn-primary">
          Link Repository
        </button>
        <button type="button" class="btn" _="on click call github_link_modal.close()">Cancel</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<!-- GitHub Settings Modal -->
<dialog id="github_settings_modal" class="modal">
  <div class="modal-box">
    <h3 class="text-2xl font-bold mb-6">GitHub Sync Settings</h3>
    <form hx-post="{{host}}/repos/{{$repo.ID}}/github/settings" hx-target="body" hx-swap="outerHTML" class="flex flex-col gap-2">
      
      <div class="alert alert-info mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
          <div class="font-semibold">Connected Repository</div>
          <a href="{{$repo.GitHubURL}}" target="_blank" class="link link-primary text-sm">{{$repo.GitHubURL}}</a>
        </div>
      </div>

      <label class="form-control w-full">
        <div class="label">
          <span class="label-text text-sm font-medium">Sync Direction</span>
        </div>
        <select name="sync_direction" class="select select-bordered w-full">
          <option value="push" {{if eq $repo.SyncDirection "push"}}selected{{end}}>Push only - Send changes to GitHub</option>
          <option value="pull" {{if eq $repo.SyncDirection "pull"}}selected{{end}}>Pull only - Receive changes from GitHub</option>
          <option value="both" {{if eq $repo.SyncDirection "both"}}selected{{end}}>Bidirectional - Sync both ways</option>
        </select>
      </label>

      <div class="form-control">
        <label class="label cursor-pointer">
          <span class="label-text">Enable automatic sync</span>
          <input type="checkbox" name="auto_sync" value="true" class="checkbox checkbox-primary" {{if $repo.AutoSync}}checked{{end}} />
        </label>
      </div>

      <div class="modal-action mt-4">
        <button type="submit" class="btn btn-primary">
          Update Settings
        </button>
        <button type="button" class="btn" _="on click call github_settings_modal.close()">Cancel</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

{{else}}
<div class="text-center py-16">
  <h2 class="text-2xl font-bold mb-4 text-error">Repository Not Found</h2>
  <p class="text-base-content/70 mb-6">The repository you're looking for doesn't exist or you don't have access to it.</p>
  <a href="{{host}}/repos" class="btn btn-primary">Back to Repositories</a>
</div>
{{end}}
{{template "layout/end"}}
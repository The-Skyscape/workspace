{{template "layout/start"}}
{{with $repo := repos.CurrentRepo}}
{{template "repo-breadcrumbs.html" .}}

{{template "repo-header.html" .}}

{{template "repo-tabs.html" .}}

<!-- Actions Container -->
<div class="container mx-auto px-4 py-6 max-w-5xl">
  
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold">Automated Actions</h2>
    <button class="btn btn-primary" _="on click call create_action_modal.showModal()">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>
      Create Action
    </button>
  </div>

  <!-- Actions List -->
{{with actions.RepoActions}}
{{if .}}
<div class="flex flex-col gap-4" hx-boost="true">
  {{range .}}
  <div class="card bg-base-100 shadow-sm border border-base-300 hover:shadow-md hover:border-primary/20 transition-all">
    <div class="card-body">
      <div class="flex items-start justify-between">
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-2">
            <a href="{{host}}/repos/{{$repo.ID}}/actions/{{.ID}}" class="font-semibold text-lg hover:text-primary transition-colors">{{.Title}}</a>
            <div class="badge badge-outline">{{.Type}}</div>
            {{if eq .Status "active"}}
            <div class="badge badge-success">Active</div>
            {{else if eq .Status "running"}}
            <div class="badge badge-warning">Running</div>
            {{else if eq .Status "disabled"}}
            <div class="badge badge-neutral">Disabled</div>
            {{else if eq .Status "failed"}}
            <div class="badge badge-error">Failed</div>
            {{else}}
            <div class="badge badge-info">{{.Status}}</div>
            {{end}}
          </div>
          {{if .Description}}
          <p class="text-base-content/70 mb-3">{{.Description}}</p>
          {{end}}
          <div class="flex items-center gap-4 text-sm text-base-content/50">
            <div class="flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Created {{.CreatedAt.Format "Jan 2, 2006"}}</span>
            </div>
            {{if .LastRun}}
            <div class="flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
              <span>Last run {{.LastRun.Format "Jan 2, 3:04 PM"}}</span>
            </div>
            {{end}}
          </div>
        </div>
        <div class="flex items-center gap-2">
          <a href="{{host}}/repos/{{$repo.ID}}/actions/{{.ID}}" class="btn btn-outline btn-sm">View</a>
          {{if eq .Type "manual"}}
          <button class="btn btn-primary btn-sm"
                  hx-post="{{host}}/repos/{{$repo.ID}}/actions/{{.ID}}/run"
                  hx-target="body"
                  hx-swap="outerHTML"
                  {{if eq .Status "running"}}disabled{{end}}>
            {{if eq .Status "running"}}
            <span class="loading loading-spinner loading-xs mr-2"></span>Running
            {{else}}
            Run
            {{end}}
          </button>
          {{end}}
          <div class="dropdown dropdown-end">
            <button class="btn btn-ghost btn-sm" tabindex="0">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
              </svg>
            </button>
            <ul class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
              <li><a href="{{host}}/repos/{{$repo.ID}}/actions/{{.ID}}">View Details</a></li>
              <li><a>Edit Action</a></li>
              <li><a>{{if eq .Status "active"}}Disable{{else}}Enable{{end}}</a></li>
              <li class="menu-title">Danger Zone</li>
              <li><a class="text-error">Delete Action</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Action Logs Modal -->
  <dialog id="action_logs_modal_{{.ID}}" class="modal">
    <div class="modal-box w-11/12">
      <h3 class="font-bold text-lg mb-4">{{.Title}} - Execution Logs</h3>
      
      <div class="flex flex-col gap-4">
        <!-- Action Info -->
        <div class="stats shadow">
          <div class="stat">
            <div class="stat-title">Status</div>
            <div class="stat-value text-sm {{if eq .Status "completed"}}text-success{{else if eq .Status "failed"}}text-error{{else if eq .Status "running"}}text-warning{{else}}text-info{{end}}">
              {{.Status}}
            </div>
          </div>
          <div class="stat">
            <div class="stat-title">Type</div>
            <div class="stat-value text-sm">{{.Type}}</div>
          </div>
          {{if .LastRun}}
          <div class="stat">
            <div class="stat-title">Last Run</div>
            <div class="stat-value text-sm">{{.LastRun.Format "Jan 2, 3:04 PM"}}</div>
          </div>
          {{end}}
          {{if .SandboxName}}
          <div class="stat">
            <div class="stat-title">Sandbox</div>
            <div class="stat-value text-sm">{{.SandboxName}}</div>
          </div>
          {{end}}
          {{if and .ExitCode (ne .ExitCode 0)}}
          <div class="stat">
            <div class="stat-title">Exit Code</div>
            <div class="stat-value text-sm text-error">{{.ExitCode}}</div>
          </div>
          {{end}}
        </div>
        
        <!-- Script -->
        <div class="card bg-base-200 shadow">
          <div class="card-body">
            <h4 class="card-title text-base">Script</h4>
            <pre class="bg-base-300 p-4 rounded text-sm overflow-x-auto"><code>{{.Script}}</code></pre>
          </div>
        </div>
        
        <!-- Output -->
        {{if .Output}}
        <div class="card bg-base-200 shadow">
          <div class="card-body">
            <h4 class="card-title text-base">Execution Output</h4>
            <pre class="bg-base-300 p-4 rounded text-sm overflow-x-auto font-mono"><code>{{.Output}}</code></pre>
          </div>
        </div>
        {{else}}
        <div class="alert alert-info">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span>No execution output available yet.</span>
        </div>
        {{end}}
        
        <!-- Artifacts -->
        <div class="card bg-base-200 shadow" hx-get="{{host}}/repos/{{$repo.ID}}/actions/{{.ID}}/artifacts" hx-trigger="load">
          <div class="card-body">
            <h4 class="card-title text-base">Artifacts</h4>
            <div class="text-sm text-base-content/70">
              <div class="loading loading-spinner loading-sm"></div> Loading artifacts...
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-action">
        <button class="btn" _="on click call action_logs_modal_{{.ID}}.close()">Close</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
  
  {{end}}
</div>
{{else}}
<div class="text-center py-16">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto mb-6 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
  </svg>
  <h2 class="text-2xl font-bold mb-4">No automated actions yet</h2>
  <p class="text-base-content/70 mb-6">Create automated workflows to handle repository tasks</p>
  <button class="btn btn-primary btn-lg" _="on click call create_action_modal.showModal()">Create First Action</button>
</div>
{{end}}
{{end}}
</div>

<!-- Create Action Modal -->
<dialog id="create_action_modal" class="modal">
  <div class="modal-box w-11/12 max-w-4xl">
    <h3 class="font-bold text-lg mb-4">Create Action</h3>
    <form hx-post="{{host}}/repos/{{.ID}}/actions/create" hx-target="body" hx-swap="outerHTML" class="flex flex-col gap-4">
      
      <!-- Basic Information -->
      <div class="flex flex-col gap-2">
        <label class="form-control w-full">
          <div class="label">
            <span class="label-text text-sm font-medium">Action Name</span>
            <span class="label-text-alt text-xs text-error">Required</span>
          </div>
          <input type="text" name="title" class="input input-bordered w-full" 
                 placeholder="Deploy to staging" required />
        </label>

        <label class="form-control w-full">
          <div class="label">
            <span class="label-text text-sm font-medium">Description</span>
            <span class="label-text-alt text-xs">Optional</span>
          </div>
          <input type="text" name="description" class="input input-bordered w-full" 
                 placeholder="Brief description of what this action does" />
        </label>
      </div>

      <!-- Simplified Configuration -->
      <div class="flex flex-col gap-2">
        <input type="hidden" name="type" value="manual" />
        
        <label class="form-control w-full">
          <div class="label">
            <span class="label-text text-sm font-medium">Branch to Run On</span>
            <span class="label-text-alt text-xs text-error">Required</span>
          </div>
          <select name="branch" class="select select-bordered w-full" required>
            {{range actions.RepoBranches}}
            <option value="{{.Name}}" {{if .IsDefault}}selected{{end}}>{{.Name}}{{if .IsDefault}} (default){{end}}</option>
            {{end}}
          </select>
          <div class="label">
            <span class="label-text-alt text-xs">Select which branch the action will run on</span>
          </div>
        </label>

        <label class="form-control w-full">
          <div class="label">
            <span class="label-text text-sm font-medium">Command to Execute</span>
            <span class="label-text-alt text-xs text-error">Required</span>
          </div>
          <textarea name="command" class="textarea textarea-bordered h-24 w-full font-mono text-sm" 
                    placeholder="npm test
npm run build
echo 'Deploy complete!'" required></textarea>
          <div class="label">
            <span class="label-text-alt text-xs">Enter commands to run (one per line)</span>
          </div>
        </label>

        <label class="form-control w-full">
          <div class="label">
            <span class="label-text text-sm font-medium">Artifacts to Collect</span>
            <span class="label-text-alt text-xs">Optional</span>
          </div>
          <input type="text" name="artifact_paths" class="input input-bordered w-full" 
                 placeholder="build.log, dist.tar.gz, test-results.xml" />
          <div class="label">
            <span class="label-text-alt text-xs">Comma-separated list of files to save after execution</span>
          </div>
        </label>
      </div>

      <!-- Quick Examples -->
      <div class="collapse collapse-arrow bg-base-200">
        <input type="checkbox" /> 
        <div class="collapse-title text-sm font-medium">Examples</div>
        <div class="collapse-content">
          <div class="flex flex-col gap-2 text-sm">
            <div class="card bg-base-100 p-3">
              <div class="font-medium mb-1">Build & Test</div>
              <code class="text-xs">npm install && npm test && npm run build</code>
            </div>
            <div class="card bg-base-100 p-3">
              <div class="font-medium mb-1">Python Tests</div>
              <code class="text-xs">python -m pytest tests/ --cov=src</code>
            </div>
            <div class="card bg-base-100 p-3">
              <div class="font-medium mb-1">Go Build</div>
              <code class="text-xs">go test ./... && go build -o app</code>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-action">
        <button type="submit" class="btn btn-primary">Create Action</button>
        <button type="button" class="btn" _="on click call create_action_modal.close()">Cancel</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
{{else}}
<div class="text-center py-16">
  <h2 class="text-2xl font-bold mb-4 text-error">Repository Not Found</h2>
  <a href="{{host}}/repos" class="btn btn-primary">Back to Repositories</a>
</div>
{{end}}
{{template "layout/end"}}